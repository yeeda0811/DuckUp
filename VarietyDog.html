<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECharts</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.2/echarts.min.js" integrity="sha512-VdqgeoWrVJcsDXFlQEKqE5MyhaIgB9yXUVaiUa8DR2J4Lr1uWcFm+ZH/YnzV5WqgKf4GPyHQ64vVLgzqGIchyw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div id="chart" style = "width:800px; height: 400px;"></div>
  <script>
    var DogArray =[];
    var DogVariety =[]
    var Dog_count =[]
    var Dog_obj = []
    var Dog_item = []
    var dataArray = []
    var url="https://data.coa.gov.tw/Service/OpenData/TransService.aspx?UnitId=QcbUEzN6E6DL";
    fetch(url,{
        method:"GET",
    }).then(response=>{
        return response.json();
    }).then(json =>{
        const year ='2022';
        const regex_y = new RegExp(year);  // 年份
        const city=2;   // 縣市代碼
        json.forEach(element => {
            if(element.animal_kind=="狗"&& regex_y.test(element.animal_createtime) &&element.animal_area_pkid==city){
                DogArray.push(element);
            }     
        });
         DogVariety= DogArray.map(item =>{
            return item.animal_Variety.trim()
        })
        console.log("DogVariety", DogVariety);

        Dog_count = DogVariety.reduce((obj,item)=>{
        if (item in obj) {
            obj[item]++
        } else {
            obj[item] = 1
        }
            return obj
        },{})
        console.log("Dog count",Dog_count);
        Dog_obj = Object.keys(Dog_count);
        Dog_num = Object.values(Dog_count);

        // 處理混種狗 = 混種犬問題
        let delSum=0; // 混種犬 ＆＆ 其他犬數量
        for(var i=0;i< Dog_obj.length; i++){
            if(Dog_obj[i]=="混種犬" || Dog_obj[i]=="其他犬"){
                  delSum+=Dog_num[i];
                  Dog_obj.splice(i,1);
                  Dog_num.splice(i,1);
            }
            // 未登記
            if(Dog_obj[i]==''){
                Dog_obj[i]="未登記";  
            }
        }
        for(var i=0;i< Dog_obj.length; i++){
            if(Dog_obj[i]=="混種狗"){
                Dog_num[i] = delSum+parseInt(Dog_num[i]);
            }
        }
        console.log("Dog_obj",Dog_obj);
        console.log("Dog_num",Dog_num);

        for(var i=0 ; i<Dog_obj.length; i++){
            const seriesData = {
                name : Dog_obj[i], 
                value : Dog_num[i]
            };
            dataArray[i] = seriesData;
        }
        console.log("dataArray",dataArray);

        var myChart = echarts.init(document.getElementById("chart"));
        // 圖表設定與資料
        var option = {
            title:{
                text : "領養狗2023",
            },
            tooltip:{
                trigger:"item",
                formatter : "{a} <br/> {b}: {c} ({d}%)",
                // a,  ,b, c, d 有特殊對應名稱
                // a = 資料所屬系列名稱
                // b = 資料項的名稱
                // c = 資料項的數值 
                // d = 資料項的佔比 
            }, 
            legend : {
                orient:"vertical",
                left:10, 
                top:30, 
                data: Dog_obj ,
            },
            series:[{
                name:"訪問來源", 
                type:"pie", 
                radius:["40%", "70%"], // 內半徑、外半徑 ->甜甜圈
                label:{
                    show:false, 
                    position:"center",
                },
                // spootlight -> 選取項目 name出現在中間
                emphasis:{
                    label:{
                        formatter:"{b}\n{c}"+" 隻",
                        show:true,
                        fontSize:"25px", 
                        fontWeight:"bold", 
                    }
                },
                data:dataArray,
            }],
        };
        myChart.setOption(option);
        }).catch(error =>{
            console.log(error);
        })
  </script>
</body>
</html>